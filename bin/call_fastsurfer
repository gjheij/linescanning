#!/usr/bin/env bash

#---------------------------------------------------------------------------------------------------------
# Create help text
function Usage {
    cat <<USAGE

---------------------------------------------------------------------------------------------------
call_fastsurfer

Run FastSurfer - a fast and accurate deep-learning based neuroimaging pipeline. This approach pro-
vides a full FreeSurfer alternative for volumetric analysis (within 1 minute) and surface-based 
thickness analysis (within only around 1h run time). The whole pipeline consists of two main parts:

(i)  FastSurferCNN - an advanced deep learning architecture capable of whole brain segmentation into 
     95 classes in under 1 minute, mimicking FreeSurferâ€™s anatomical segmentation and cortical par-
     cellation (DKTatlas)

(ii) recon-surf - full FreeSurfer alternative for cortical surface reconstruction, mapping of cor-
     tical labels and traditional point-wise and ROI thickness analysis in approximately 60 minutes. 
     For surface group analysis, sphere.reg can be additionally generated by adding the --surfreg 
     flag.

Args:
  -s <subject>  subject ID
  -d <sub dir>  FastSurfer's equivalent of SUBJECTS_DIR
  <t1 ref>      reference t1-weighted image

Usage:
  call_fastsurfer -s <subject> <t1w reference>

Example:
  call_fastsurfer -s sub-001 t1w.nii.gz

---------------------------------------------------------------------------------------------------

USAGE
    exit 1
}

if [[ $# -lt 1 ]] ; then
  Usage >&2
  exit 1
fi

# Check for subject & session flags
while getopts s:d: argument
do
  case ${argument} in
    s)  sub=${OPTARG}
          ;;
    d)  dir=${OPTARG}
          ;;          
  esac
done

INPUT=${@:$OPTIND:1}

#-----------------------------------------------------------------------------
# Run it
# Source FreeSurfer
module load freesurfer/6.0.0

if [ -z ${dir} ]; then
  SUBJ_DIR=${DIR_DATA_DERIV}/fastsurfer
else
  SUBJ_DIR=${dir}
fi

export FASTSURFER_HOME=/data1/projects/MicroFunc/Jurjen/programs/packages/FastSurfer

# Run FastSurfer (fastsurfer is an alias for run_fastsurfer.sh)
source activate base
fastsurfer --t1 ${INPUT} --sid ${sub} --sd ${SUBJ_DIR} --parallel --threads 4 --surf_only
