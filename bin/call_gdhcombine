#!/usr/bin/env python

import os
from nilearn import image
from scipy import ndimage
import sys, getopt
from linescanning.utils import get_file_from_substring
opj = os.path.join

def main(argv):

    """
---------------------------------------------------------------------------------------------------
call_gdhcombine

Combine the outputs from FAST (fmriprep or FSL itself), FreeSurfer, and Nighres' MGDM. If possible, 
we will also include CAT12-segmentations. These should be located in DIR_DATA_DERIV/cat12/sub-xxx/.
Also takes in manual edits that are weighted 5-times more than the segmentations from the other
softwares. 

Args:
    -s <subject nr>  subject ID
    -q <CAT12>       directory in DIR_DATA_DERIV containing labels from CAT12 (optional!)
    -a <FAST>        directory containing segmentations from FAST
    -b <FreeSurfer>  directory containing segmentations from FreeSurfer
    -c <Nighres>     directory containing segmentations from Nighres
    -d <Manual>      directory containing manual edits
    -o <Output>      output directory + basename output

Example:
    call_gdhcombine -s sub-001 -a /path/to/fast -b /path/to/fs -c /path/to/mgdm -d /path/to
                    /man_masks

Notes:
    if you only specify the subject ID, it will look for the files in the environmental variables
    Nighres/FreeSurfer/fMRIprep are compulsory, manual edits & CAT12 are optional!
---------------------------------------------------------------------------------------------------
    """

    subject     = None
    fprep_prob  = None
    fs          = None
    nigh_prob   = None
    nigh_prob   = None
    cat_prob    = None
    outputdir   = None
    outputbase  = None

    try:
        opts = getopt.getopt(argv,"hs:q:a:f:c:d:o:b:",["subject=", "session=","cat=", "fast=", "fs=", "nighres=", "manual=", "outputdir=", "outputbase="])[0]
    except getopt.GetoptError:
        print(main.__doc__)
        sys.exit(2)

    for opt, arg in opts:
        if opt == '-h':
            print(main.__doc__)
            sys.exit()
        elif opt in ("-s", "--subject"):
            subject = arg
        elif opt in ("-q", "--cat"):
            cat_prob = arg            
        elif opt in ("-a", "--fast"):
            fprep_prob = arg
        elif opt in ("-f", "--fs"):
            fs = arg
        elif opt in ("-c", "--nighres"):
            nigh_prob = arg
        elif opt in ("-d", "--manual"):
            man_edit = arg
        elif opt in ("-o", "--output"):
            outputdir = arg
        elif opt in ("-b", "--outputbase"):
            outputbase = arg

    if len(argv) < 1:
            print("\nNEED AT LEAST A SUBJECT ID")
            print(main.__doc__)
            sys.exit()

    # print(f"subject:     {subject}")
    # print(f"CAT12:       {cat}")
    # print(f"FAST:        {fast}")
    # print(f"FS:          {fs}")
    # print(f"MGDM:        {mgdm}")
    # print(f"Manual:      {manual}")
    # print(f"Output dir:  {outputdir}")
    # print(f"Output base: {outputbase}")

    # At least fMRIprep/Nighres/FreeSurfer need to be specified. Manual & CAT12 are optional
    if not fprep_prob:
        raise ValueError("Need an fmriprep-directory")

    if not nigh_prob:
        raise ValueError("Need a nighres-directory")

    if not fs:
        raise ValueError("Need a FreeSurfer-directory")

    ## Load and resample
    print("Load and resample segmentations to nighres-output")
    try:
        ## Manual edits (optional)
        print(" manual edits..")
        manual = {}
        manual['wm']    = get_file_from_substring('manualsegwm', man_edit)
        manual['gm']    = get_file_from_substring('manualseggm', man_edit)
    except:
        manual = None
    
    ## Nighres: compulsory
    print(" nighres..")
    nighres = {}
    nighres['wm']      = get_file_from_substring('proba_cr-wm.nii.gz', nigh_prob)
    nighres['gm']      = get_file_from_substring('proba_cr-gm.nii.gz', nigh_prob)
    nighres['csf']     = get_file_from_substring('proba_cr-csf.nii.gz', nigh_prob)

    for i in nighres:
        if nighres[i] == None:
            print(f" Missing {i}-file from mgdm")
            sys.exit(1)

    ## fMRIprep: compulsory
    print(" fmriprep..")
    fmriprep = {}
    fmriprep['wm']  = image.resample_to_img(get_file_from_substring('label-WM', fprep_prob), nighres['gm'], interpolation='nearest')
    fmriprep['gm']  = image.resample_to_img(get_file_from_substring('label-GM', fprep_prob), nighres['gm'], interpolation='nearest')
    fmriprep['csf'] = image.resample_to_img(get_file_from_substring('label-CSF', fprep_prob), nighres['gm'], interpolation='nearest')

    for i in fmriprep:
        if fmriprep[i] == None:
            print(f" Missing {i}-file from fmriprep")
            sys.exit(1)

    ## CAT12: optional
    if cat_prob:
        try:
            print(" CAT12..")
            cat = {}
            cat['wm']   = image.resample_to_img(get_file_from_substring('p2', cat_prob), nighres['gm'], interpolation='nearest')
            cat['gm']   = image.resample_to_img(get_file_from_substring('p1', cat_prob), nighres['gm'], interpolation='nearest')
            cat['csf']  = image.resample_to_img(get_file_from_substring('p3', cat_prob), nighres['gm'], interpolation='nearest')
        except:
            cat['wm'],cat['gm'],cat['csf'] = None,None,None

    # print("  Creating cerebrum mask..")
    # cereb_mask = image.math_img('wm + gm + csf',
    #                             wm=mgdm['wm'],
    #                             gm=mgdm['gm'],
    #                             csf=mgdm['csf'])
    
    # cereb_mask.to_filename(output + '_space-mp2rage_desc-cerebrum.nii.gz')
    # print(manual)
    # print(fmriprep)
    # print(mgdm)

    ## FreeSurfer: compulsory
    try:
        aseg = get_file_from_substring("aseg_dseg.nii.gz", fprep_prob)
    except:
        aseg = opj(fs, subject, 'mri', 'aseg.nii.gz')
        mgz  = opj(fs, subject, 'mri', 'aseg.mgz')
        if not os.path.exists(aseg):

            if os.path.exists(mgz):
                print("Converting aseg.mgz to aseg.nii.gz")
                try:
                    os.system(f'call_mriconvert {mgz}')
                except:
                    try:
                        os.system("mri_convert --in_type mgz --out_type nii {mgz} {nii}".format(mgz=mgz, nii=aseg))
                    except:
                        raise OSError('Could not find function mri_convert')
            else:
                print("Could not find aseg.mgz")
                sys.exit(1)

    print(" FreeSurfer..")
    freesurfer_seg = image.resample_to_img(aseg,
                                           nighres['gm'],
                                           interpolation='nearest')

    freesurfer = {}
    freesurfer['wm'] = image.math_img('((seg == 2).astype(int) + (seg == 41).astype(int))', seg=freesurfer_seg)
    freesurfer['gm'] = image.math_img('((seg == 3).astype(int) + (seg == 42).astype(int))', seg=freesurfer_seg)

    print("Combining segmentations")
    print(" wm..")
    if manual['wm'] != None:
        wm = image.math_img('fmriprep + mgdm + freesurfer + manual*5',
                            mgdm=nighres['wm'],
                            fmriprep=fmriprep['wm'],
                            freesurfer=freesurfer['wm'],
                            manual=image.resample_to_img(manual['wm'], nighres['wm'], interpolation='nearest'))
    else:
        wm = image.math_img('fmriprep + mgdm + freesurfer',
                            mgdm=nighres['wm'],
                            fmriprep=fmriprep['wm'],
                            freesurfer=freesurfer['wm'])
    
    # Include CAT12 segmentation if present
    if cat['wm']:
        wm = image.math_img('wm + cat', 
                            wm=wm,
                            cat=cat['wm'])

    print(" gm..")
    if manual['gm'] != None:
        # gm = image.math_img('fmriprep + mgdm + freesurfer + manual*5',
        #                     mgdm=nighres['gm'],
        #                     fmriprep=fmriprep['gm'],
        #                     freesurfer=freesurfer['gm'],
        #                     manual=image.resample_to_img(manual['gm'], nighres['gm']))

        gm = image.math_img('fmriprep + freesurfer + manual*5',
                            fmriprep=fmriprep['gm'],
                            freesurfer=freesurfer['gm'],
                            manual=image.resample_to_img(manual['gm'], nighres['gm']))                            
    else:
        gm = image.math_img('fmriprep + mgdm + freesurfer',
                        mgdm=nighres['gm'],
                        fmriprep=fmriprep['gm'],
                        freesurfer=freesurfer['gm'])
    # Include CAT12 segmentation if present
    if cat['gm']:
        gm = image.math_img('gm + cat*3', 
                            gm=gm,
                            cat=cat['gm'])

    print(" csf..")
    # csf = image.math_img('3 * mgdm + 0*fmriprep', mgdm=mgdm['csf'], fmriprep=fmriprep['csf'])
    csf = image.math_img('3 * mgdm', mgdm=nighres['csf'])

    # Include CAT12 segmentation if present
    if cat['csf']:
        csf = image.math_img('csf + cat', 
                            csf=csf,
                            cat=cat['csf'])

    print(" total..")
    total_prob = image.math_img('wm + gm + csf',
                                wm=wm,
                                gm=gm,
                                csf=csf)

    print("Calculate new probabilities and save files")
    wm = image.math_img('wm / total_prob', wm=wm, total_prob=total_prob)
    gm = image.math_img('gm / total_prob', gm=gm, total_prob=total_prob)
    csf = image.math_img('csf / total_prob', csf=csf, total_prob=total_prob)

    wm.to_filename(opj(outputdir, outputbase + '_label-WM_probseg.nii.gz')); print(" wrote new WM-probability map")
    gm.to_filename(opj(outputdir, outputbase + '_label-GM_probseg.nii.gz')); print(" wrote new GM-probability map")
    csf.to_filename(opj(outputdir, outputbase + '_label-CSF_probseg.nii.gz')); print(" wrote new CSF-probability map")

    inside_mask = image.math_img('wm > 0.45', wm=wm)
    inside_mask = image.largest_connected_component_img(inside_mask)
    inside_mask = image.new_img_like(inside_mask,ndimage.binary_closing(inside_mask.get_fdata(),iterations=3))
    inside_mask.to_filename(opj(outputdir, outputbase + '_desc-inside.nii.gz')); print(" wrote 'inside'-map")

    print("Done")
if __name__ == "__main__":
    main(sys.argv[1:])