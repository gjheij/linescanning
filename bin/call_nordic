#!/bin/bash
#$ -S /bin/bash
#$ -cwd
#$ -j Y
#$ -V

#---------------------------------------------------------------------------------------------------------
# Create help text
function Usage {
    cat <<USAGE

---------------------------------------------------------------------------------------------------
call_nordic

Applies the NORDIC algorithm to whole-brain data. Requires the magnitude image, the phase image, and 
an output name

Args:
  -m        use magnitude only
  <mag>     magnitude image
  <phase>   phase image
  <output>  nordic'ed output

Usage:
  call_nordic [-m] <mag file> <phase file> <nordic output>

Example:
  call_nordic func_mag.nii.gz func_phase.nii.gz func_nordic.nii.gz      # mag + phase
  call_nordic -m func_mag.nii.gz func_phase.nii.gz func_nordic.nii.gz   # mag only

---------------------------------------------------------------------------------------------------

USAGE
    exit 1
}

if [[ $# -lt 3 ]] ; then
  Usage >&2
  exit 1
fi

IMG_MAGN=${@:$OPTIND:1}
IMG_PHASE=${@:$OPTIND+1:1}
IMG_NORDIC=${@:$OPTIND+2:1}

#-----------------------------------------------------------------------------
# Get bash helper functions
source call_bashhelper

#-----------------------------------------------------------------------------
# Add entire path if just filename is specified
fn_mag=`fetch_filepath ${IMG_MAGN}`
fn_phase=`fetch_filepath ${IMG_PHASE}`
fn_nordic=`fetch_filepath ${IMG_NORDIC}`

#-----------------------------------------------------------------------------
# Get extension from input file
ext_nordic=`fetch_extension ${fn_nordic}`

# nordic output
if [[ ${ext_nordic} == "gz" ]]; then
  fn_nordic=$(dirname ${fn_nordic})/$(basename ${fn_nordic} .nii.gz)
elif [[ ${ext_nordic} == "nii" ]]; then
  fn_nordic=$(dirname ${fn_nordic})/$(basename ${fn_nordic} .nii)
else
  echo "ERROR in `basename ${0}`: unrecognized extension \"${ext_nordic}\" for NORDIC output"
  exit 1
fi

#-----------------------------------------------------------------------------
# Set the NORDIC mode
if [[ "${@}" == *"-m"* ]]; then 
  mag_only=1
else
  mag_only=0
fi 

#-----------------------------------------------------------------------------
# Create new script
new_script=$(dirname ${fn_mag})/nordic.m
if [[ -f ${new_script} ]]; then
  rm -r ${new_script}
fi

#-----------------------------------------------------------------------------
# Run new script
if [[ -f ${fn_mag} && -f ${fn_phase} ]]; then

  make_nordic_script ${fn_mag} ${fn_phase} ${fn_nordic} ${mag_only} ${new_script}

  # call_matlab = in call_bashhelper
  call_matlab ${new_script}

  if [[ $? -ne 0 ]]; then
    echo "ERROR: matlab exited with non-zero status"
    exit 1
  fi

else
  echo "Missing files for NORDIC; need a magnitude & phase image, got \"${IMG_MAGN}\" and \"${IMG_PHASE}\""
fi

#-----------------------------------------------------------------------------
# Reset extension 
if [[ ${ext_nordic} == "gz" ]]; then
    gzip ${fn_nordic}.nii
fi