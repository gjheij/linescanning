#!/usr/bin/env bash
#$ -S /bin/bash
#$ -N pybest
#$ -e $HOME/logs
#$ -o $HOME/logs
#$ -q LONG_QUEUE
#$ -j Y
#$ -cwd
#$ -V

#---------------------------------------------------------------------------------------------------------
# Create help text
function Usage {
    cat <<USAGE

---------------------------------------------------------------------------------------------------
call_pybest

wrapper for pybest that takes the output from fMRIprep and denoises the data. The output of this
script is a set up numpy arrays that can be loaded in by prf_fitting.ipynb. It is important to
have pybest in a conda environment, as it uses the newest version of Nilearn which has not been
released yet (https://github.com/nilearn/nilearn). By default, call_pybest will look for an envi-
ronment called fmriprep_denoising, but you can specify your own environment as long as it has py-
best in it. Check for instruction this page https://github.com/lukassnoek/pybest.

Usage:
  call_pybest -r <subject number> -n <session number> -o <output directory> -s <space>
              -f <fprep dir> -c <slots> -e <environment> -v <setup file>

Arguments:
  -r <sub number>     number of subject's FreeSurfer directory from which you can omit "sub-" (e.g.,
                      for "sub-001", enter "001"). If left empty pybest will process everything it
                      can find in the fmriprep folder
  -n <ses number>     session number. If left empty pybest will process everything it can find in
                      the fmriprep folder.
  -o <output dir>     path to output directory. By default it will create a subject-specific folder,
                      but you can set where that subject folder is going to go. By default this
                      script will output to /projectroot/derivatives/pybest
  -s <space>          the space to process. fMRIprep outputs several kinds of standard spaces such
                      as the MNI152NLin2009cAsym, or FSL-templates, but also fsnative. The latter
                      is the default, because we want to project the results in pycortex.
  -f <fprep dir>      path to fmriprep derivatives directory. Will look by default in the /project/
                      derivatives/fmriprep
  -c <n_slots>        number of slots to use when we're on a cluster
  -e <environment>    string containing the name of the conda environment. We will check with conda
                      info --envs if the environment exists. By default we will look for something
                      containing fmriprep_denoising if left blank
  -z <standardizing>  method for signal standardization; 'zscore' or 'psc'

Example:
  call_pybest -r "001" -n "1" -o /derivatives/pybest -s "fsnative" -f /derivatives/fmriprep -c 10
  call_pybest -r "001" -n "1" -o /derivatives/pybest -s "fsnative" -f /derivatives/fmriprep -c 10
              -e pybest
  call_pybest -r "001" -o /derivatives/pybest -s "MNI152NLin2009cAsym" -f /derivatives/fmriprep

---------------------------------------------------------------------------------------------------

USAGE
    exit 1
}

while getopts r:n:o:s:f:c:e:z:v: arg; do
  case $arg in
    r)  run=${OPTARG}
          ;;
    n)  ses=${OPTARG}
          ;;
    o)  outputdir=${OPTARG}
          ;;
    s)  in_space=${OPTARG}
          ;;
    f)  fprepdir=${OPTARG}
          ;;
    c)  n_slots=${OPTARG}
          ;;
    e)  env=${OPTARG}
          ;;
    z)  normalization=${OPTARG}
          ;;
    v)  setup=${OPTARG}
          ;;
  esac
done

if [[ $# -lt 4 ]] ; then
  Usage >&2
  exit 1
fi

#---------------------------------------------------------------------------------------------------------
# if we qsub this script we need a setup file, we need to specify the setup file for environmental variables
if [ ! -z $setup ]; then
  source $setup
else
  #---------------------------------------------------------------------------------------------------------
  # check if there's is a setup file containing the major paths and source it if it exists
  call_loadsetup
fi

#-----------------------------------------------------------------------------
## ACTIVATE ENVIRONMENT WITH PYBEST IN IT (default is fmriprep_denoising)
# Check if specified environment exists, otherwise check for default
if [[ ! -z $env ]]; then
  check_env=${env}
else
  check_env="linescanning"
fi

conda_env=`conda info --envs | grep -A0 "${check_env}" | cut -d' ' -f1  `
if [[ -z ${conda_env} ]]; then
  echo
  echo "ERROR:could not find conda environment. Please specify correct environment of create one names \"fmriprep_denoising\""
  exit 1
fi

# Make sure we run the specified subject or all subjects pybest can find will be
# processed
if [[ ! -z ${run} ]]; then
  sub_input="--subject ${run}"
else
  sub_input=""
fi

# Make sure we run the specified session or all sessions pybest can find will be
# processed
if [[ ! -z ${ses} ]]; then
  ses_input="--session ${ses}"
  base_dir="sub-${run}/ses-${ses}"
else
  ses_input=""
  base_dir="sub-${run}"
fi

# Make sure we run the specified session or all sessions pybest can find will be
# processed
if [[ ! -z ${task} ]]; then
  task_input="--task ${task}"
else
  task_input=""
fi

# Set output directory if specified, otherwise default to /derivatives/pybest
if [[ ! -z ${outputdir} ]]; then
  output_dir=${outputdir}
else
  output_dir=${DIR_DATA_DERIV}/pybest
fi

# Set input directory if specified, otherwise default to /derivatives/pybest
if [[ ! -z ${fprepdir} ]]; then
  input_dir=${fprepdir}
else
  input_dir=${DIR_DATA_DERIV}/fmriprep
fi

# Make sure we run with the specified amount of slots
if [[ ! -z ${n_slots} ]]; then
  cpu_input="--n-cpus ${n_slots}"
else
  cpu_input=""
fi

# Make sure we run with the specified amount of slots
if [[ ! -z ${normalization} ]]; then
  norm_input="--normalization ${normalization}"
else
  norm_input=""
fi

#
# source activate ${env}
source activate ${conda_env}
if [[ ! -d ${output_dir}/sub-${run} ]]; then
  mkdir -p ${output_dir}/sub-${run}
fi

if [ ! -d ${input_dir}/${base_dir}/func ]; then
  echo "ERROR: no func in \"${input_dir}/${base_dir}\""
  echo "       make sure to run \"master -m 15 -s ${run} -t func\" to fMRIprep with FS-surfaces"
  exit 1
fi

if [[ ${in_space} == "fsnative" ]]; then

  # running left hemisphere
  # echo "pybest ${sub_input} ${ses_input} ${task_input} --space ${in_space} --hemi L ${cpu_input} --verbose ERROR ${input_dir}"
  pybest ${sub_input} ${ses_input} ${task_input} --space ${in_space} --hemi L ${cpu_input} ${norm_input} --verbose ERROR --save-all ${input_dir}

  # running left hemisphere
  pybest ${sub_input} ${ses_input} ${task_input} --space ${in_space} --hemi R ${cpu_input} ${norm_input} --verbose ERROR --save-all ${input_dir}

else

  pybest ${sub_input} ${ses_input} ${task_input} --space ${in_space} ${norm_input} --verbose ERROR --save-all ${input_dir}

fi
